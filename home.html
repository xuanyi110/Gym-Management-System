<!DOCTYPE html>
<html>
    <head>
        <title>La Habana Fitness</title>
    </head>
    <style>
        #body {
            width: 100%;
        }
        #buttons {
            width: 40%;
            height: 600px;
            float: left;
            overflow: scroll;
        }
        #queryOutput {
            margin-left: 40%;
            border: 1px solid;
            height: 600px;
            overflow: scroll;
        }
        td {
            border: 1px solid;
        }
    </style>
    <body onload="renderQueries()">
        <script type="text/javascript" src="client/lambertQueries.js"></script>
        <script type="text/javascript" src="client/ryanQueries.js"></script>
        <script type="text/javascript" src="client/jQueries.js"></script>
        <script>
            function renderQueries() {
                var allQueries = [...lambertQ, ...ryanQ, ...jQ];
                var buttonsContainer = document.getElementById('buttons');
                for (let q of allQueries) {
                    var apiName = q['apiName'];
                    var userInputs = q['userInputs'];
                    var queryContainer = document.createElement("div");
                    queryContainer.appendChild(document.createTextNode(q['text'] + ': '));
                    var button = document.createElement('button');
                    button.id = apiName;
                    button.addEventListener('click', buttonHandler(q));
                    button.innerHTML = 'Get';
                    queryContainer.appendChild(button);
                    if (userInputs) {
                        queryContainer.appendChild(document.createElement('br'));
                        for (let userInput of userInputs) {
                            queryContainer.appendChild(document.createTextNode(userInput + ': '));
                            var box = document.createElement('INPUT');
                            box.setAttribute('type', 'text');
                            box.id = apiName + '.' + userInput;
                            queryContainer.appendChild(box);
                            queryContainer.appendChild(document.createElement('br'));
                        }
                    }
                    buttonsContainer.appendChild(queryContainer);
                    buttonsContainer.appendChild(document.createElement('hr'));
                }
            }

            function buttonHandler(q) {
                var requestInputs = {};
                var apiName = q['apiName'];
                var inputs = q['inputs'];
                var userInputs = q['userInputs'];
                if (inputs) {
                    requestInputs = inputs;
                }
                return () => {
                    if (userInputs) {
                        for (let userInput of userInputs) {
                            var field = document.getElementById(apiName + '.' + userInput).value;
                            requestInputs[userInput] = field;
                        }
                    }
                    var xhttp = new XMLHttpRequest();
                    xhttp.onreadystatechange = function() {
                        if (this.readyState == 4 && this.status == 200) {
                            console.log(JSON.parse(this.responseText));
                            showTable(this.responseText);
                        }
                    };
                    xhttp.open("POST", "http://localhost:8080", true);
                    xhttp.setRequestHeader("Content-Type", "application/json");
                    xhttp.send(JSON.stringify({"apiName": apiName, "inputs": requestInputs}));
                }
            }

            function showTable(res) {
                var resArr = JSON.parse(res);
                if (resArr.length === 0) {
                    document.getElementById('queryOutput').textContent = 'No result';
                    return;
                }
                var table = document.createElement('TABLE');
                var titleRow = document.createElement('TR');
                for (let col in resArr[0]) {
                    var cell = document.createElement('TD');
                    cell.appendChild(document.createTextNode(col));
                    titleRow.appendChild(cell);
                }
                table.appendChild(titleRow);
                for (let resRow of resArr) {
                    var tableRow = document.createElement('TR');
                    for (let resCell in resRow) {
                        var tableCell = document.createElement('TD');
                        tableCell.appendChild(document.createTextNode(resRow[resCell]));
                        tableRow.appendChild(tableCell);
                    }
                    table.appendChild(tableRow);
                }
                document.getElementById('queryOutput').textContent = '';
                document.getElementById('queryOutput').appendChild(table);
            }
        </script>
        <h1>La Habana Fitness</h1>
        <div id='body'>
            <div id="buttons"></div>
            <div id="queryOutput"></div>
        </div>
    </body>
</html>